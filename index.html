<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Plant Green House</title>

  <!-- Material Icons & Fonts -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #2b9348;
      --accent-color: #8ac926;
      --warning-color: #f72585;
      --dark-color: #212121;
      --gradient-1: linear-gradient(45deg, #2b9348, #8ac926);
      --box-shadow: 0 6px 22px rgba(0,0,0,0.08);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f3f7f4;
      color: var(--dark-color);
      text-align: center;
      margin: 0;
      padding: 0;
    }

    .header {
      background: var(--gradient-1);
      color: white;
      padding: 24px 0;
      box-shadow: var(--box-shadow);
    }

    h1 { margin: 8px 0; font-size: 28px; }
    p.lead { margin: 0; opacity: 0.95; }

    .container { padding: 18px; }

    .card {
      background: #fff;
      padding: 20px;
      margin: 12px;
      border-radius: 12px;
      box-shadow: var(--box-shadow);
      width: 280px;
      display: inline-block;
      vertical-align: top;
      text-align: left;
    }

    .card h3 { margin: 0 0 6px 0; font-size: 16px; }
    .sensor-value {
      font-size: 2.2rem;
      font-weight: 600;
      color: var(--dark-color);
      margin: 8px 0;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 14px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-badge.ok { background: rgba(138,201,38,0.12); color: var(--accent-color); }
    .status-badge.warn { background: rgba(247,37,133,0.12); color: var(--warning-color); }
    .status-badge.alert { background: rgba(255,99,71,0.12); color: #ff6347; }

    /* Login form */
    #loginForm {
      margin: 70px auto;
      max-width: 420px;
      background: #fff;
      padding: 22px;
      border-radius: 12px;
      box-shadow: var(--box-shadow);
    }

    #loginForm input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1.5px solid #ddd;
      border-radius: 10px;
    }

    #loginForm button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }

    #dashboard { display: none; }
    #logoutBtn {
      background: #f72585;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      margin-top: 18px;
      cursor: pointer;
    }

    .meta { font-size: 0.85rem; color: #666; margin-top: 8px; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginForm">
    <h2>Login Smart Plant Green House</h2>
    <input type="email" id="email" placeholder="Email" value="aldisyahputra696@gmail.com" />
    <input type="password" id="password" placeholder="Password" value="Admin123" />
    <button id="loginBtn">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="header">
      <h1>Smart Plant Green House</h1>
      <p class="lead">Monitoring Kelembaban Tanah, Cahaya, Keamanan & Deteksi Hama</p>
    </div>

    <div class="container" id="sensorCards">
      <div class="card">
        <h3>Kelembaban Tanah</h3>
        <div id="soilMoisture" class="sensor-value">-- %</div>
        <span class="status-badge" id="soilStatus">Memuat...</span>
        <div class="meta" id="soilNote">Ambang kering: &lt; 40%</div>
      </div>

      <div class="card">
        <h3>Tingkat Cahaya</h3>
        <div id="lightLevel" class="sensor-value">-- %</div>
        <span class="status-badge" id="lightStatus">Memuat...</span>
        <div class="meta">Gunakan data ini untuk kontrol lampu / lokasi</div>
      </div>

      <div class="card">
        <h3>Deteksi Gerakan (PIR)</h3>
        <div id="motion" class="sensor-value">--</div>
        <span class="status-badge" id="motionStatus">Memuat...</span>
        <div class="meta">Mendeteksi hewan atau orang</div>
      </div>

      <div class="card">
        <h3>Deteksi Api</h3>
        <div id="flame" class="sensor-value">--</div>
        <span class="status-badge" id="flameStatus">Memuat...</span>
        <div class="meta">Peringatan dini kebakaran</div>
      </div>

      <div class="card">
        <h3>Deteksi Objek / Jarak</h3>
        <div id="object" class="sensor-value">--</div>
        <span class="status-badge" id="objectStatus">Memuat...</span>
        <div class="meta">Sensor jarak / objek (cm atau 'Ada')</div>
      </div>
    </div>

    <div style="margin-top:16px;">
      <div class="meta" id="lastUpdated">Last updated: -</div>
    </div>

    <button id="logoutBtn">Logout</button>
  </div>

  <!-- Firebase SDK & Chart.js (Chart.js kept if you later add charts)-->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // === Firebase Config (versi terbaru) ===
    const firebaseConfig = {
      apiKey: "AIzaSyC3SBYQvIzAO5ZigAFmN-qRQvi5Hq6mVEk",
      authDomain: "smarthome-5320a.firebaseapp.com",
      databaseURL: "https://smarthome-5320a-default-rtdb.firebaseio.com",
      projectId: "smarthome-5320a",
      storageBucket: "smarthome-5320a.firebasestorage.app",
      messagingSenderId: "430840264108",
      appId: "1:430840264108:web:b9b19a88b0fb56ba25b609"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Helper safe parse
    function safeNum(v, fallback = null) {
      if (v === undefined || v === null) return fallback;
      const n = parseFloat(v);
      return isNaN(n) ? fallback : n;
    }

    // === Login ===
    document.getElementById("loginBtn").addEventListener("click", () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          document.getElementById("loginForm").style.display = "none";
          document.getElementById("dashboard").style.display = "block";
          listenToSensors();
        })
        .catch((e) => alert("Login gagal: " + e.message));
    });

    // === Logout ===
    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth);
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    });

    // === Listen to Firebase Realtime Database ===
    function listenToSensors() {
      // path database: gunakan node "greenhouse" untuk membedakan dari project smart home lama
      const sensorRef = ref(db, "greenhouse/sensors");
      onValue(sensorRef, (snapshot) => {
        const data = snapshot.val() || {};

        // soil moisture (expected 0-100 atau analog)
        const soil = safeNum(data.soilMoisture ?? data.soil ?? data.moisture);
        if (soil !== null) {
          document.getElementById("soilMoisture").innerText = soil.toFixed(1) + " %";
          const soilBadge = soil < 40 ? ["status-badge warn","Kering"] : ["status-badge ok","Cukup"];
          document.getElementById("soilStatus").className = soilBadge[0];
          document.getElementById("soilStatus").innerText = soilBadge[1];
          document.getElementById("soilNote").innerText = "Ambang kering: < 40% (sesuaikan)";
        } else {
          document.getElementById("soilMoisture").innerText = "-- %";
          document.getElementById("soilStatus").className = "status-badge warn";
          document.getElementById("soilStatus").innerText = "Tidak tersedia";
        }

        // lightLevel (0-100)
        const light = safeNum(data.lightLevel ?? data.light);
        if (light !== null) {
          document.getElementById("lightLevel").innerText = light.toFixed(0) + " %";
          const lightBadge = light < 50 ? ["status-badge warn","Gelap"] : ["status-badge ok","Cukup Cahaya"];
          document.getElementById("lightStatus").className = lightBadge[0];
          document.getElementById("lightStatus").innerText = lightBadge[1];
        } else {
          document.getElementById("lightLevel").innerText = "-- %";
          document.getElementById("lightStatus").className = "status-badge warn";
          document.getElementById("lightStatus").innerText = "Tidak tersedia";
        }

        // motion (PIR) -> expect 0/1 or boolean
        const motionRaw = data.motion ?? data.pir;
        let motionText = "--";
        if (motionRaw !== undefined && motionRaw !== null) {
          const m = (motionRaw === 1 || motionRaw === true || motionRaw === "1" || motionRaw === "true");
          motionText = m ? "Ada" : "Tidak";
          document.getElementById("motion").innerText = motionText;
          document.getElementById("motionStatus").className = m ? "status-badge alert" : "status-badge ok";
          document.getElementById("motionStatus").innerText = m ? "Terdeteksi" : "Aman";
        } else {
          document.getElementById("motion").innerText = "--";
          document.getElementById("motionStatus").className = "status-badge warn";
          document.getElementById("motionStatus").innerText = "Tidak tersedia";
        }

        // flame sensor -> expect boolean or numeric (1 detected)
        const flameRaw = data.flame ?? data.flameDetected ?? data.fire;
        if (flameRaw !== undefined && flameRaw !== null) {
          const f = (flameRaw === 1 || flameRaw === true || flameRaw === "1" || flameRaw === "true");
          document.getElementById("flame").innerText = f ? "Terbakar!" : "Aman";
          document.getElementById("flameStatus").className = f ? "status-badge alert" : "status-badge ok";
          document.getElementById("flameStatus").innerText = f ? "Bahaya" : "Aman";
        } else {
          document.getElementById("flame").innerText = "--";
          document.getElementById("flameStatus").className = "status-badge warn";
          document.getElementById("flameStatus").innerText = "Tidak tersedia";
        }

        // object detection / distance -> could be cm value or boolean
        const objRaw = data.object ?? data.distance ?? data.ultrasonic;
        if (objRaw !== undefined && objRaw !== null) {
          const objNum = safeNum(objRaw);
          if (objNum !== null) {
            document.getElementById("object").innerText = objNum.toFixed(1) + " cm";
            document.getElementById("objectStatus").className = objNum < 20 ? "status-badge alert" : "status-badge ok";
            document.getElementById("objectStatus").innerText = objNum < 20 ? "Dekat" : "Jauh";
          } else {
            // boolean presence
            const present = (objRaw === 1 || objRaw === true || objRaw === "1" || objRaw === "true");
            document.getElementById("object").innerText = present ? "Ada" : "Tidak";
            document.getElementById("objectStatus").className = present ? "status-badge alert" : "status-badge ok";
            document.getElementById("objectStatus").innerText = present ? "Terdeteksi" : "Tidak";
          }
        } else {
          document.getElementById("object").innerText = "--";
          document.getElementById("objectStatus").className = "status-badge warn";
          document.getElementById("objectStatus").innerText = "Tidak tersedia";
        }

        // last updated
        const ts = data.timestamp ?? data.lastUpdated ?? Date.now();
        const d = new Date(ts);
        document.getElementById("lastUpdated").innerText = "Last updated: " + d.toLocaleString();

      }, (error) => {
        console.error("Firebase read failed: ", error);
        alert("Gagal membaca data sensor: " + error.message);
      });
    }
  </script>
</body>
</html>
